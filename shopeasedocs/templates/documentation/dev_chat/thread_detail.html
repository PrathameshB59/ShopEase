{% extends 'base.html' %}
{% load static %}

{% block title %}{{ thread.title }} - Developer Chat - ShopEase Documentation{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'documentation/css/dev-chat.css' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <div id="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h4 class="mb-0">{{ thread.title }}</h4>
                    <div class="thread-meta">
                        <span>
                            <i class="bi bi-person"></i> Created by {{ thread.created_by.username }}
                        </span>
                        <span>
                            <i class="bi bi-clock"></i> {{ thread.created_at|timesince }} ago
                        </span>
                        <span class="badge bg-{% if thread.status == 'OPEN' %}success{% elif thread.status == 'RESOLVED' %}primary{% else %}secondary{% endif %}">
                            {{ thread.get_status_display }}
                        </span>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button"
                            id="threadActions" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'documentation:dev_chat_list' %}">
                                <i class="bi bi-arrow-left"></i> Back to Threads
                            </a>
                        </li>
                        {% if user == thread.created_by or user.is_superuser %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{% url 'documentation:edit_thread' thread.id %}">
                                <i class="bi bi-pencil"></i> Edit Thread
                            </a>
                        </li>
                        {% if thread.status == 'OPEN' %}
                        <li>
                            <form method="post" action="{% url 'documentation:resolve_thread' thread.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item text-success">
                                    <i class="bi bi-check-circle"></i> Mark as Resolved
                                </button>
                            </form>
                        </li>
                        {% endif %}
                        {% if thread.status != 'ARCHIVED' %}
                        <li>
                            <form method="post" action="{% url 'documentation:archive_thread' thread.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item text-secondary">
                                    <i class="bi bi-archive"></i> Archive Thread
                                </button>
                            </form>
                        </li>
                        {% endif %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% if thread.description %}
            <p class="mt-2 mb-0 opacity-75">{{ thread.description }}</p>
            {% endif %}
            {% if thread.tags %}
            <div class="mt-2">
                {% for tag in thread.tags|split:"," %}
                <span class="badge bg-light text-dark">{{ tag|trim }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Messages Container -->
        <div id="messages-container" data-thread-id="{{ thread.id }}">
            {% if messages_list %}
            {% for message in messages_list %}
            <div class="message-item {% if message.author == user %}sent{% else %}received{% endif %}"
                 data-message-id="{{ message.id }}"
                 data-timestamp="{{ message.created_at|date:'c' }}">
                <div class="message-bubble">
                    <div class="message-header">
                        <strong>{{ message.author.username }}</strong>
                        <span class="text-muted small">{{ message.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="message-content">{{ message.content }}</div>
                    {% if message.attachment %}
                    <div class="message-attachment">
                        <i class="bi bi-paperclip"></i>
                        <a href="{{ message.attachment.url }}" target="_blank" class="text-decoration-none">
                            {{ message.attachment.name }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="chat-empty-state">
                <i class="bi bi-chat-dots"></i>
                <h5>No Messages Yet</h5>
                <p>Be the first to start the conversation!</p>
            </div>
            {% endif %}
        </div>

        <!-- Chat Input -->
        {% if thread.status != 'ARCHIVED' %}
        <div class="chat-input-container">
            <form id="message-form" class="chat-input-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="chat-input-wrapper">
                    <textarea id="message-input" name="content" class="chat-input"
                              placeholder="Type your message..." rows="2" required></textarea>
                    <div id="file-preview" class="file-preview" style="display: none;">
                        <span id="file-name"></span>
                        <span class="remove-file" onclick="removeFile()">
                            <i class="bi bi-x-circle"></i>
                        </span>
                    </div>
                </div>
                <div class="d-flex flex-column gap-2">
                    <label for="file-input" class="attach-file-btn mb-0">
                        <i class="bi bi-paperclip"></i>
                    </label>
                    <input type="file" id="file-input" name="attachment" style="display: none;"
                           onchange="previewFile(this)">
                    <button type="submit" class="chat-send-btn" id="send-btn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="chat-input-container bg-light">
            <div class="alert alert-warning mb-0">
                <i class="bi bi-archive"></i> This thread is archived. No new messages can be posted.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Scroll to Bottom Button -->
    <button id="scroll-to-bottom" onclick="scrollToBottom()">
        <i class="bi bi-arrow-down"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'documentation/js/chat-polling.js' %}"></script>
<script>
    const threadId = {{ thread.id }};
    let chatPoller;

    // Initialize chat polling
    document.addEventListener('DOMContentLoaded', function() {
        {% if thread.status != 'ARCHIVED' %}
        chatPoller = new ChatPoller(threadId, 5000); // Poll every 5 seconds
        {% endif %}

        // Auto-scroll to bottom on load
        scrollToBottom();

        // Handle message form submission
        const form = document.getElementById('message-form');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const sendBtn = document.getElementById('send-btn');
                const messageInput = document.getElementById('message-input');

                // Disable button during submission
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

                try {
                    const response = await fetch('{% url "documentation:post_message" thread.id %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Clear form
                        messageInput.value = '';
                        removeFile();

                        // Add message to UI immediately
                        appendMessage(data.message);

                        // Scroll to bottom
                        scrollToBottom();
                    } else {
                        alert('Failed to send message: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="bi bi-send-fill"></i>';
                }
            });
        }

        // Show scroll button when scrolling up
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.addEventListener('scroll', function() {
            const scrollBtn = document.getElementById('scroll-to-bottom');
            if (this.scrollHeight - this.scrollTop - this.clientHeight > 100) {
                scrollBtn.style.display = 'flex';
            } else {
                scrollBtn.style.display = 'none';
            }
        });
    });

    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }

    function previewFile(input) {
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');

        if (input.files && input.files[0]) {
            fileName.textContent = input.files[0].name;
            filePreview.style.display = 'flex';
        }
    }

    function removeFile() {
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');

        fileInput.value = '';
        filePreview.style.display = 'none';
    }

    function appendMessage(messageData) {
        const container = document.getElementById('messages-container');
        const isSent = messageData.author_id == {{ user.id }};

        const messageHTML = `
            <div class="message-item ${isSent ? 'sent' : 'received'}"
                 data-message-id="${messageData.id}"
                 data-timestamp="${messageData.created_at}">
                <div class="message-bubble">
                    <div class="message-header">
                        <strong>${messageData.author}</strong>
                        <span class="text-muted small">${formatTimestamp(messageData.created_at)}</span>
                    </div>
                    <div class="message-content">${messageData.content}</div>
                    ${messageData.attachment ? `
                        <div class="message-attachment">
                            <i class="bi bi-paperclip"></i>
                            <a href="${messageData.attachment_url}" target="_blank" class="text-decoration-none">
                                ${messageData.attachment}
                            </a>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;

        // Remove empty state if exists
        const emptyState = container.querySelector('.chat-empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        container.insertAdjacentHTML('beforeend', messageHTML);
    }

    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        const options = { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('en-US', options);
    }

    // Handle keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter to send message
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const form = document.getElementById('message-form');
            if (form) {
                form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            }
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (chatPoller) {
            chatPoller.stop();
        }
    });
</script>
{% endblock %}
